<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Camera Analyzer</title>

  <style>
    :root{
      --bg:#071426;
      --card:#0b2240;
      --border:rgba(255,255,255,.14);
      --text:#eaf2ff;
      --muted:#a9b9d6;
      --accent:#3b82f6;
      --accent2:#2563eb;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --radius:20px;
      --shadow:0 18px 45px rgba(0,0,0,.35);
      --max:860px;
      --cb-orange:#FF7A00;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(37,99,235,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width:var(--max);margin:0 auto;padding:18px}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }

    h1{margin:0;font-size:30px;letter-spacing:.4px;
      background:linear-gradient(90deg,#22c55e,#3b82f6);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .sub{margin:6px 0 0;color:var(--muted);font-weight:600}

    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;}

    .banner{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .banner b{color:#fff}
    .banner a{color:#fff;text-decoration:underline}

    .viewer{
      margin-top:14px;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      position:relative;
    }
    video{width:100%;height:100%;object-fit:cover}

    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      text-align:center;
    }
    .overlay.hidden{display:none}
    .overlay .box{
      max-width:560px;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(7,20,38,.72);
    }
    .overlay .box b{display:block;margin-bottom:6px}
    .overlay .box p{margin:0;color:var(--muted);font-size:13px;line-height:1.45}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:14px}

    .radios{
      display:flex;
      gap:14px;
      align-items:center;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
    }

    label{display:flex;gap:8px;align-items:center;font-weight:700}

    .btn{
      padding:12px 16px;
      border-radius:16px;
      border:0;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      font-weight:900;
      cursor:pointer;
      min-width:180px;
      text-align:center;
    }

    .btn.secondary{
      background:rgba(255,255,255,.08);
      border:1px solid var(--border);
      font-weight:800;
      min-width:auto;
    }

    .btn.danger{
      background:rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.35);
      color:#fff;
    }

    .btn.warn{
      background:rgba(245,158,11,.14);
      border:1px solid rgba(245,158,11,.35);
      color:#fff;
    }

    .btn:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}

    .field label{display:block;margin-bottom:8px;font-weight:900}

    textarea{
      width:100%;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-size:14px;
      line-height:1.45;
      resize:vertical;
    }

    .status{margin-top:10px;color:var(--muted);font-size:13px;white-space:pre-wrap}
    .status.ok{color:rgba(34,197,94,.95)}
    .status.err{color:rgba(239,68,68,.95)}
    .status.warn{color:rgba(245,158,11,.95)}

    .hint{margin-top:10px;color:var(--muted);font-size:12px}

    .preview{
      margin-top:10px;
      display:none;
      width:100%;
      border-radius:18px;
      border:1px solid var(--border);
    }

    .mini{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .mini code{color:#fff}

    /* Responsive */
    @media (max-width:720px){
      .wrap{padding:12px}
      .card{padding:14px}
      h1{font-size:26px}
      .sub{font-size:13px}

      .row{flex-direction:column;align-items:stretch}
      .field .row{flex-direction:row;align-items:center}

      .btn{width:100%;min-width:0}
      .btn.secondary{width:auto}

      .radios{width:100%;flex-direction:column;align-items:flex-start;gap:10px}

      .viewer{border-radius:16px}
      textarea{font-size:14px}
    }

    @media (max-width:520px){
      h1{font-size:24px}
      .banner{font-size:12px}
      .viewer{aspect-ratio:4/3;max-height:55vh}
      .overlay .box{max-width:92%}
    }

    @media (max-width:380px){
      .card{padding:12px}
      textarea{padding:10px}
      .btn{padding:12px 14px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1>Online Camera Analyzer</h1>
          <p class="sub">By CallBot<span style="color:var(--cb-orange);font-weight:900;">IA</span></p>
        </div>
      </div>

      <div class="banner" id="envBanner">
        <b>Requisitos de cámara:</b> debe abrirse en <b>HTTPS</b> (o <b>localhost</b>). Si lo abrís como archivo (<code>file://</code>) o dentro de un iframe sin permisos, Safari puede bloquear la cámara.
        <span id="openTab" style="display:none"> — <a href="#" id="openNewTab">Abrir en nueva pestaña</a></span>
      </div>

      <div class="viewer" aria-label="Vista de cámara">
        <video id="video" autoplay playsinline muted></video>

        <div id="overlay" class="overlay">
          <div class="box">
            <b>Para activar la cámara</b>
            <p>
              Presioná <strong>Activar cámara</strong> y aceptá el permiso.
              Si aparece <strong>NotAllowedError</strong>, es porque el permiso fue negado, el contexto no es seguro, o la plataforma no permite cámara en este entorno.
            </p>
          </div>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <button class="btn" id="start">Activar cámara</button>
        <button class="btn danger" id="stop" disabled>Detener</button>
      </div>

      <div class="row">
        <div class="radios" role="radiogroup" aria-label="Seleccionar cámara">
          <label>
            <input type="radio" name="cam" value="environment" checked>
            Cámara trasera
          </label>
          <label>
            <input type="radio" name="cam" value="user">
            Cámara delantera
          </label>
        </div>

        <button class="btn" id="snap" disabled>Sacar fotografía</button>
      </div>

      <img id="photoPreview" class="preview" alt="Foto capturada" />

      <div class="grid">
        <div class="field">
          <label>Descripción</label>
          <textarea id="desc" rows="9" placeholder="Aquí aparecerá una descripción breve."></textarea>
        </div>

        <div class="field">
          <div class="row" style="margin:0">
            <label style="margin:0;flex:1">Recomendaciones</label>
            <button class="btn secondary" id="tts" type="button">Text-to-Speech</button>
          </div>
          <textarea id="reco" rows="4" placeholder="Aquí aparecerán recomendaciones complementarias."></textarea>
        </div>
      </div>

      <div class="status" id="status"></div>
      <div class="mini" id="diagnostics"></div>

      <div class="hint">
        Si el backend <code>/api/analyze</code> está desplegado en Vercel, la descripción y recomendaciones se completan automáticamente.
      </div>

      <canvas id="canvas" hidden></canvas>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const snapBtn = document.getElementById('snap');
    const desc = document.getElementById('desc');
    const reco = document.getElementById('reco');
    const statusEl = document.getElementById('status');
    const preview = document.getElementById('photoPreview');
    const ttsBtn = document.getElementById('tts');
    const overlay = document.getElementById('overlay');
    const diagnostics = document.getElementById('diagnostics');
    const openTabWrap = document.getElementById('openTab');
    const openNewTabLink = document.getElementById('openNewTab');

    let stream = null;

    function setStatus(msg, kind){
      statusEl.textContent = msg || '';
      statusEl.classList.remove('ok','err','warn');
      if(kind) statusEl.classList.add(kind);
    }

    function selectedMode(){
      return document.querySelector('input[name="cam"]:checked')?.value || 'environment';
    }

    function isSecure(){
      // Safari: localhost se considera seguro; file:// NO.
      return window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    }

    function inIframe(){
      try { return window.self !== window.top; } catch { return true; }
    }

    function showOverlay(show){
      overlay.classList.toggle('hidden', !show);
    }

    function stopCamera(){
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      snapBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      showOverlay(true);
      setStatus('Cámara detenida.', 'ok');
    }

    function notAllowedHelp(){
      const lines = [];
      lines.push('NotAllowedError: permiso denegado o bloqueado por el entorno.');
      lines.push('');
      lines.push('Checklist:');
      lines.push('• Abrí la página en HTTPS (no file://).');
      lines.push('• Aceptá el permiso cuando el navegador lo pida.');
      lines.push('• Si lo negaste: habilitá Cámara para este sitio en Safari.');
      lines.push('• Si estás dentro de un iframe/preview: abrí en una pestaña normal del navegador.');
      return lines.join('\n');
    }

    function explainError(e){
      const name = e?.name || '';
      if(name === 'NotAllowedError') return notAllowedHelp();
      if(name === 'NotFoundError') return 'No se encontró una cámara disponible (NotFoundError).\n• Verificá que el dispositivo tenga cámara activa.';
      if(name === 'NotReadableError') return 'La cámara está en uso por otra app (NotReadableError).\n• Cerrá otras apps que estén usando la cámara.';
      if(name === 'OverconstrainedError') return 'No se pudo aplicar la configuración solicitada (OverconstrainedError).\n• Probá cambiar a la otra cámara.';
      return 'No se pudo abrir la cámara.\n• Verificá HTTPS/permiso.';
    }

    async function startCamera(mode){
      try{
        setStatus('Solicitando permiso de cámara…');

        if(!navigator.mediaDevices?.getUserMedia){
          setStatus('Este navegador no soporta cámara.', 'err');
          return;
        }

        if(!isSecure()){
          setStatus('Contexto no seguro: la cámara requiere HTTPS (o localhost).', 'err');
          showOverlay(true);
          return;
        }

        // Si está embebido, muchos entornos bloquean cámara.
        if(inIframe()){
          setStatus('Advertencia: este módulo está corriendo dentro de un iframe/preview. Algunos entornos bloquean la cámara. Probá abrirlo en una pestaña.', 'warn');
        }

        if(stream){ stream.getTracks().forEach(t => t.stop()); }

        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: mode },
            width: { ideal: 1280 },
            height:{ ideal: 720 }
          },
          audio: false
        });

        video.srcObject = stream;
        await video.play();

        startBtn.disabled = true;
        stopBtn.disabled = false;
        snapBtn.disabled = false;
        showOverlay(false);
        setStatus('Cámara lista.', 'ok');
      } catch (e){
        console.error(e);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        snapBtn.disabled = true;
        showOverlay(true);
        setStatus(explainError(e), 'err');
      }
    }

    function buildFallback(){
      return {
        description:
          'Foto capturada correctamente.\n\n' +
          'No se pudo contactar el backend /api/analyze.\n' +
          'Desplegá este proyecto en Vercel para habilitar IA real.',
        recommendations:
          'Ejemplos complementarios:\n' +
          '• Fideos → tuco, queso rallado, vino\n' +
          '• Pizza → fainá, birra, aceitunas\n' +
          '• Café → medialunas, torta\n' +
          '• Asado → chimichurri, ensalada'
      };
    }

    async function analyzeWithBackend(dataUrl){
      const r = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_data_url: dataUrl })
      });

      if(!r.ok){
        const t = await r.text().catch(()=> '');
        throw new Error('HTTP ' + r.status + ' ' + t);
      }

      return r.json();
    }

    // Eventos
    startBtn.addEventListener('click', () => startCamera(selectedMode()));
    stopBtn.addEventListener('click', stopCamera);

    document.querySelectorAll('input[name="cam"]').forEach(r => {
      r.addEventListener('change', () => {
        if(stream){ startCamera(selectedMode()); }
      });
    });

    snapBtn.addEventListener('click', async () => {
      if(!stream){ setStatus('Cámara no iniciada.', 'err'); return; }

      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);

      const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
      preview.src = dataUrl;
      preview.style.display = 'block';

      setStatus('Analizando imagen con IA…', 'warn');

      try{
        const out = await analyzeWithBackend(dataUrl);
        desc.value = out?.description || '';
        reco.value = out?.recommendations || '';
        setStatus('Listo. Recomendaciones generadas.', 'ok');
      }catch(err){
        console.error(err);
        const fb = buildFallback();
        desc.value = fb.description;
        reco.value = fb.recommendations;
        setStatus('Backend no disponible. Usando ejemplo.', 'warn');
      }

      try{ window.__lastPhotoDataUrl = dataUrl; }catch(_){ }
    });

    ttsBtn.addEventListener('click', () => {
      const text = reco.value.trim();
      if(!text){ setStatus('No hay recomendaciones para leer.', 'err'); return; }

      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-ES';
        window.speechSynthesis.speak(u);
        setStatus('Reproduciendo audio…', 'ok');
      } catch (e){
        console.error(e);
        setStatus('Text-to-Speech no disponible.', 'err');
      }
    });

    // Abrir en nueva pestaña (útil si el entorno actual bloquea permisos)
    openNewTabLink.addEventListener('click', (e) => {
      e.preventDefault();
      try{
        window.open(location.href, '_blank', 'noopener,noreferrer');
      }catch(_){
        location.href = location.href;
      }
    });

    // Self-tests (simples)
    (function selfTests(){
      const required = ['video','canvas','start','stop','snap','desc','reco','status','tts','overlay','diagnostics','openTab','openNewTab'];
      const missing = required.filter(id => !document.getElementById(id));
      const secureMsg = isSecure() ? 'OK' : 'NO (usa HTTPS o localhost)';
      const iframeMsg = inIframe() ? 'SÍ' : 'NO';
      const proto = location.protocol;

      // Test del helper NotAllowed
      let helperOk = true;
      try {
        const sample = notAllowedHelp();
        helperOk = typeof sample === 'string' && sample.includes('NotAllowedError');
      } catch {
        helperOk = false;
      }

      // Test del fallback (evita strings inválidos)
      let fallbackOk = true;
      try {
        const fb = buildFallback();
        fallbackOk = typeof fb.description === 'string' && typeof fb.recommendations === 'string' && fb.recommendations.includes('Fideos');
      } catch {
        fallbackOk = false;
      }

      // Test: CSS/HTML no deben romper el parseo (sanity)
      const bodyClosed = !!document.body;

      diagnostics.innerHTML =
        '<b>Diagnóstico rápido</b><br>' +
        `Protocolo: <code>${proto}</code><br>` +
        `Contexto seguro: <code>${secureMsg}</code><br>` +
        `En iframe/preview: <code>${iframeMsg}</code><br>` +
        `DOM ok: <code>${bodyClosed ? 'OK' : 'FALLÓ'}</code><br>` +
        `Navegador: <code>${navigator.userAgent}</code><br>` +
        `Helper NotAllowed: <code>${helperOk ? 'OK' : 'FALLÓ'}</code><br>` +
        `Fallback strings: <code>${fallbackOk ? 'OK' : 'FALLÓ'}</code><br>` +
        (missing.length ? `Faltan elementos: <code>${missing.join(', ')}</code>` : `Elementos UI: <code>OK</code>`);

      openTabWrap.style.display = inIframe() ? 'inline' : 'none';

      if(missing.length){
        setStatus('Error interno: faltan elementos en el DOM.', 'err');
      } else if(!isSecure()){
        setStatus('Estás en un contexto NO seguro. Abrí en HTTPS o localhost para permitir cámara.', 'err');
      } else {
        setStatus('Presioná “Activar cámara” para comenzar.', 'ok');
      }
    })();
  </script>
</body>
</html>
